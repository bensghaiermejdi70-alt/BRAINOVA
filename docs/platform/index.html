<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Brainova - Mini Platform (work copy)</title>
  <!-- Quick redirect: some users have trouble opening the platform shell directly.
       Redirect to the canonical global page which is known to open correctly. -->
  <script>
    (function(){
      try{
        if(location.pathname.endsWith('/platform/') || location.pathname.endsWith('/platform') || location.pathname.endsWith('/platform/index.html')){
          location.replace('/brainova.html');
        }
      }catch(e){ /* ignore */ }
    })();
  </script>
  <style>
    /* Critical CSS (maquette-like) */
    body{margin:0;font-family:Rajdhani,Segoe UI,Arial;background:linear-gradient(135deg,#0a0a0a 0%,#1a1a2e 50%,#16213e 100%);color:#fff}
    .loader{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#0b1220,#11223a);z-index:9999}
    .spinner{width:48px;height:48px;border:4px solid rgba(255,255,255,0.15);border-top-color:#00d4ff;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .header{background:linear-gradient(135deg,rgba(0,0,0,0.95),rgba(26,26,46,0.9));backdrop-filter:blur(20px);border-bottom:2px solid #00d4ff;padding:12px 16px;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:1000}
    .games-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;padding:20px 16px}
    .game-card{background:linear-gradient(135deg,rgba(0,0,0,0.9),rgba(26,26,46,0.8));border:2px solid #00d4ff;padding:16px;border-radius:16px;cursor:pointer}
    .game-number{font-weight:700;color:#00d4ff}
  .game-actions .action-btn{padding:6px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);font-weight:700;cursor:pointer}
  .buy-btn.owned{background:linear-gradient(45deg,#d3d3d3,#bfbfbf);color:#333;border-color:rgba(0,0,0,0.06);cursor:default}
    /* per-card customizations removed to restore default platform styling */
    .logo h1{font-family:Orbitron,monospace;font-size:1.4rem;margin:0}
    .nav-btn{background:linear-gradient(45deg,#00d4ff,#ff0096);border:none;border-radius:20px;padding:8px 14px;color:#fff;font-weight:700;cursor:pointer}
  </style>
</head>
<body>
  <div class="loader" id="loader"><div class="spinner" aria-hidden></div></div>
  <header class="header" id="header" style="display:none">
    <div class="logo"><h1>🧠 BRAINOVA</h1></div>
    <nav class="nav" style="display:flex;gap:8px;align-items:center">
      <button class="nav-btn" onclick="location.href='global_platform.html'">Accueil</button>
      <button id="btnLogin" class="nav-btn">Connexion</button>
      <button id="btnSignup" class="nav-btn">Inscription</button>
  <a class="nav-btn" href="./brainova.html?bundle_purchased=1" target="_blank" rel="noopener noreferrer" style="background:linear-gradient(45deg,#ffd700,#ff7a00);">Pass Premium</a>
      <div id="userSigle" style="width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,#00d4ff,#ff0096);display:flex;align-items:center;justify-content:center;color:#001;font-weight:800;margin-left:8px;display:none">JD</div>
      <div style="position:relative;margin-left:8px">
        <button id="settingsBtn" class="nav-btn" style="padding:6px 8px">⚙️</button>
        <div id="settingsMenu" style="position:absolute;right:0;top:40px;background:#0b1220;border:1px solid rgba(255,255,255,0.04);padding:6px;border-radius:8px;display:none;min-width:160px">
          <div style="padding:8px;color:#cfefff;cursor:pointer" id="settingsEditProfile">Changer profil</div>
          <div style="padding:8px;color:#cfefff;cursor:pointer" id="settingsHistory">Historique</div>
        </div>
      </div>
      <div id="langPicker" style="position:relative;margin-left:8px">
        <select id="langSelect" aria-label="Langue" title="Langue" style="appearance:none;-webkit-appearance:none;-moz-appearance:none;display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:14px;border:1px solid rgba(0,212,255,0.12);background:linear-gradient(135deg,#061229 0%,#08223a 100%);color:#cfefff;cursor:pointer;font-weight:700">
          <option value="fr">🇫🇷 Français</option>
          <option value="en">🇬🇧 English</option>
          <option value="ar">🇸🇦 العربية</option>
          <option value="es">🇪🇸 Español</option>
          <option value="de">🇩🇪 Deutsch</option>
          <option value="zh">🇨🇳 中文</option>
        </select>
      </div>
    </nav>
  </header>

  <main class="main" style="max-width:1200px;margin:18px auto;padding:0 18px">
    <section class="hero" id="catalog-hero" style="padding:18px;background:linear-gradient(135deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:12px;margin-bottom:18px">
      <div style="max-width:1200px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;gap:18px;flex-wrap:wrap">
        <div style="display:flex;align-items:center;gap:14px">
          <div style="width:96px;height:96px;border-radius:12px;background:linear-gradient(135deg,#00d4ff,#ff0096);display:flex;align-items:center;justify-content:center;font-size:28px;font-weight:900;color:#001;padding:12px;box-shadow:0 8px 40px rgba(0,212,255,0.08)">36<br><small style="font-size:10px;color:#001;font-weight:700">JEUX</small></div>
          <div>
            <h2 style="margin:0;font-family:Orbitron,monospace;color:#00d4ff">Catalogue Brainova — 36 jeux</h2>
            <p style="margin:6px 0;color:#cfefff">Explorez par thème : sélectionnez une catégorie pour filtrer les cartes de jeux.</p>
          </div>
        </div>
        <div id="catalogCats" style="display:flex;gap:12px;flex-wrap:wrap">
          <button class="cat" data-filter="all" style="padding:10px 14px;background:linear-gradient(135deg,rgba(0,0,0,0.6),rgba(26,26,46,0.6));border:1px solid rgba(255,255,255,0.03);border-radius:10px;color:#cfefff;cursor:pointer">Tous</button>
          <button class="cat" data-filter="memoire" style="padding:10px 14px;background:linear-gradient(135deg,rgba(0,0,0,0.6),rgba(26,26,46,0.6));border:1px solid rgba(255,255,255,0.03);border-radius:10px;color:#cfefff;cursor:pointer">Mémoire</button>
          <button class="cat" data-filter="quiz" style="padding:10px 14px;background:linear-gradient(135deg,rgba(0,0,0,0.6),rgba(26,26,46,0.6));border:1px solid rgba(255,255,255,0.03);border-radius:10px;color:#cfefff;cursor:pointer">Quiz</button>
          <button class="cat" data-filter="puzzle" style="padding:10px 14px;background:linear-gradient(135deg,rgba(0,0,0,0.6),rgba(26,26,46,0.6));border:1px solid rgba(255,255,255,0.03);border-radius:10px;color:#cfefff;cursor:pointer">Puzzle</button>
          <button class="cat" data-filter="arcade" style="padding:10px 14px;background:linear-gradient(135deg,rgba(0,0,0,0.6),rgba(26,26,46,0.6));border:1px solid rgba(255,255,255,0.03);border-radius:10px;color:#cfefff;cursor:pointer">Arcade</button>
        </div>
      </div>
    </section>

    <main id="gamesGrid" class="games-grid" aria-live="polite"></main>
  </main>

  <script>
    // --- begin header interactivity (language, settings, login/signup) ---
    (function(){
      const Translations = {
        fr: { login: 'Connexion', signup: 'Inscription' },
        en: { login: 'Login', signup: 'Sign up' },
        ar: { login: 'تسجيل الدخول', signup: 'إنشاء حساب' },
        es: { login: 'Conexión', signup: 'Registro' },
        de: { login: 'Anmelden', signup: 'Registrieren' },
        zh: { login: '登录', signup: '注册' }
      };

      function applyHeaderLang(code){
        const t = Translations[code] || Translations.fr;
        const b1 = document.getElementById('btnLogin'); if(b1) b1.textContent = t.login;
        const b2 = document.getElementById('btnSignup'); if(b2) b2.textContent = t.signup;
      }

      const langSelect = document.getElementById('langSelect');
      if(langSelect){
        const stored = localStorage.getItem('brainovaLang') || 'fr';
        langSelect.value = stored;
        applyHeaderLang(stored);
        langSelect.addEventListener('change', ()=>{
          localStorage.setItem('brainovaLang', langSelect.value);
          applyHeaderLang(langSelect.value);
        });
      }

      // settings button toggle
      const settingsBtn = document.getElementById('settingsBtn');
      const settingsMenu = document.getElementById('settingsMenu');
      if(settingsBtn && settingsMenu){
        settingsBtn.addEventListener('click', ()=>{
          settingsMenu.style.display = settingsMenu.style.display === 'block' ? 'none' : 'block';
        });
        document.addEventListener('click', (e)=>{ if(!settingsBtn.contains(e.target) && !settingsMenu.contains(e.target)) settingsMenu.style.display='none'; });
      }

      // simple nav actions
  const btnLogin = document.getElementById('btnLogin'); if(btnLogin) btnLogin.addEventListener('click', ()=>{ try{ parent.postMessage({ action: 'dialog', dialogType: 'alert', text: 'Connexion (placeholder)' }, '*'); }catch(e){} });
  const btnSignup = document.getElementById('btnSignup'); if(btnSignup) btnSignup.addEventListener('click', ()=>{ try{ parent.postMessage({ action: 'dialog', dialogType: 'alert', text: 'Inscription (placeholder)' }, '*'); }catch(e){} });
    })();
    // --- end header interactivity ---
    window.PlatformConfig = { totalGames: 36, currentLanguage: 'fr', gameModules: new Map() };

    // --- Bundle / Pack support ---
    // If you sell a single "Pass Premium" bundle (all premium games),
    // configure the hosted Payment Link in the header 'Pass Premium' anchor
    // or set localStorage.bundlePaymentLink. After successful payment the
    // Payment Link can redirect back to the site with ?bundle_purchased=1&email=...
    // We detect that and mark all premium games owned locally.
    function getBundleLink(){
      // Try header anchor first
      try{
        const anchor = document.querySelector('a.nav-btn[href*="buy.stripe.com"]');
        if(anchor && anchor.href) return anchor.href;
      }catch(e){}
      // Fallback to explicit localStorage override
      return localStorage.getItem('bundlePaymentLink') || null;
    }

    function handleBundleRedirectFromURL(){
      // Parse query params and store basic purchase/session info to localStorage.
      try{
        const params = new URLSearchParams(window.location.search);
        const sessionId = params.get('session_id') || params.get('checkout_session_id');
        const email = params.get('email') || params.get('customer_email');
        const bundleFlag = params.get('bundle_purchased') === '1' || params.get('bundle') === '1' || params.get('payment') === 'success';

        if(sessionId) localStorage.setItem('last_stripe_session', sessionId);
        if(email) localStorage.setItem('brainovaUserEmail', email);
        if(bundleFlag) localStorage.setItem('bundlePurchased','1');
      }catch(e){ /* ignore parsing errors */ }

      // Clean the querystring to keep URL neat
      try{
        const clean = window.location.pathname + window.location.hash;
        window.history.replaceState({}, document.title, clean);
      }catch(e){}

      // Verify purchases server-side (best-effort) and apply gating
      (function(){
        (async function(){
          try{
            let purchases = [];
            const s = localStorage.getItem('last_stripe_session');
            const e = localStorage.getItem('brainovaUserEmail');
            if(s){
              try{ const resp = await fetch('/.netlify/functions/check-purchase?session_id=' + encodeURIComponent(s)); if(resp.ok){ const d = await resp.json(); purchases = purchases.concat(d.purchases || []); } }catch(_){ }
            }
            if(e){
              try{ const resp2 = await fetch('/.netlify/functions/check-purchase?email=' + encodeURIComponent(e)); if(resp2.ok){ const d2 = await resp2.json(); purchases = purchases.concat(d2.purchases || []); } }catch(_){ }
            }
            if(purchases.length > 0) localStorage.setItem('bundlePurchased','1');
            applyPurchaseGating();
          }catch(err){ console.warn('post-check verification failed', err); }
        })();
      })();

      // Attempt to preload games-index and then init platform
      (function(){
        import('./games/games-index.js').then(mod=>{ window.GamesIndex = mod.default; }).catch(()=>{ /* ignore */ }).finally(()=>{ try{ initPlatform(); }catch(e){} });
      })();
    }

    function loadScriptAsync(src){
      return new Promise((resolve,reject)=>{
        const s = document.createElement('script');
        s.src = src;
        s.async = false; // preserve execution order for core scripts
        s.onload = ()=>resolve();
        s.onerror = (e)=>reject(e);
        document.head.appendChild(s);
      });
    }

    function loadCSSAsync(href){
      return new Promise((resolve)=>{
        const l = document.createElement('link');
        l.rel = 'stylesheet';
        l.href = href;
        l.media = 'print';
        l.onload = function(){ l.media = 'all'; resolve(); };
        l.onerror = function(){ /* resolve even if CSS fails to load */ resolve(); };
        document.head.appendChild(l);
      });
    }

    function waitFor(cond, timeout){
      return new Promise((resolve)=>{
        const start = Date.now();
        (function tick(){
          try{ if(cond()) return resolve(true); }catch(e){}
          if(Date.now()-start > timeout) return resolve(false);
          setTimeout(tick, 50);
        })();
      });
    }

    function initPlatform(){
      document.getElementById('loader').style.display='none';
      document.getElementById('header').style.display='flex';
      // detect possible redirect from a Payment Link and mark bundle if present
      try{ handleBundleRedirectFromURL(); }catch(e){/* ignore */}
      loadGameCards();
      setupCategoryFilters();
      // Attempt to apply purchase gating if we have an email stored
      applyPurchaseGating();
    }

    async function applyPurchaseGating(){
      try{
        const email = localStorage.getItem('brainovaUserEmail');
        const bundleOwned = localStorage.getItem('bundlePurchased') === '1';
        if(!email && !bundleOwned) return;

        // If we have an email, query server purchases; otherwise rely on bundle flag
        let purchases = [];
        if(email){
          try{
            const resp = await fetch(`/.netlify/functions/check-purchase?email=${encodeURIComponent(email)}`);
            if(resp.ok){
              const data = await resp.json();
              purchases = data.purchases || [];
            }
          }catch(e){ /* ignore and continue, bundleOwned may still apply */ }
        }

        const ownedGameIds = new Set();
        purchases.forEach(p=>{
          try{
            const meta = p.metadata || p.metadata_value || {};
            const m = (typeof meta === 'string') ? JSON.parse(meta || '{}') : meta;
            if(m.game_id) ownedGameIds.add(String(m.game_id));
          }catch(e){}
        });

        // If bundle was purchased, mark all premium ids as owned (0 and 11..36)
        if(bundleOwned){
          for(let i=0;i<=36;i++){
            if(i === 0 || (i >= 11 && i <= 36)) ownedGameIds.add(String(i));
          }
        }

        if(ownedGameIds.size === 0) return;
        // disable buy buttons for owned games
        const grid = document.getElementById('gamesGrid');
        const buyButtons = grid.querySelectorAll('.buy-btn');
        buyButtons.forEach(b=>{
          const gid = b.getAttribute('data-game');
          if(ownedGameIds.has(String(gid))){
            b.textContent = 'Déjà acheté';
            b.disabled = true;
            b.classList.add('owned');
            b.style.opacity = '0.6';
          }
        });
      }catch(e){ console.warn('applyPurchaseGating error', e); }
    }

    function loadGameCards(){
      const grid = document.getElementById('gamesGrid');
        for(let i=0;i<=36;i++){
          const card = document.createElement('div'); card.className='game-card'; card.dataset.gameId=i;
          card.innerHTML = `
            <div class="game-header">
              <div class="game-number">${String(i).padStart(2,'0')}</div>
              <div class="game-status">--</div>
            </div>
            <div class="game-icon">🎮</div>
            <h3>Jeu ${i}</h3>
            <p>Chargement…</p>
            <div class="game-tags"></div>
            <div class="game-stats"><span>--</span><span>--</span></div>
          `;
          observeCard(card);
          grid.appendChild(card);
        }
    }

    async function loadGameContent(card){
      const id = card.dataset.gameId;
      // use central games-index module
      try{
          const GamesIndex = (await import('./games/games-index.js')).default;
            // ensure consistent markup from GamesIndex
            const html = GamesIndex.getCardHTML(id);
            // apply any per-card outer style (e.g. accent for 'qi') to the .game-card
            if(typeof GamesIndex.getCardStyle === 'function'){
              const styleText = GamesIndex.getCardStyle(id) || '';
              if(styleText) card.style.cssText += styleText;
            }
            // If GamesIndex provides inner markup, replace innerHTML, otherwise keep fallback
            card.innerHTML = html || card.innerHTML;
            card.onclick = ()=>GamesIndex.launch(id);
        window.PlatformConfig.gameModules.set(id, true);
      }catch(e){ /* keep placeholder */ }
    }

    function observeCard(card){
      const obs = new IntersectionObserver((entries, o)=>{ entries.forEach(e=>{ if(e.isIntersecting){ loadGameContent(e.target); o.unobserve(e.target); } }); }, {rootMargin:'200px'});
      obs.observe(card);
    }

    // Build a simple tags index and wire up category buttons
    function setupCategoryFilters(){
      const cats = document.querySelectorAll('#catalogCats .cat');
      // For quick lookup, build a map of id -> tags from GamesIndex if available
      const tagsMap = new Map();
      try{
        if(window.GamesIndex && typeof window.GamesIndex.getCardTags === 'function'){
          for(let i=0;i<=36;i++) tagsMap.set(String(i), window.GamesIndex.getCardTags(i));
        }
      }catch(e){ /* ignore */ }

      function applyFilter(filter){
        const grid = document.getElementById('gamesGrid');
        const cards = grid.querySelectorAll('.game-card');
        cards.forEach(card=>{
          const id = card.dataset.gameId;
          if(filter === 'all'){ card.style.display = ''; return; }
          const tags = tagsMap.get(id) || [];
          if(tags.indexOf(filter) !== -1) card.style.display = '';
          else card.style.display = 'none';
        });
      }

      cats.forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const f = btn.getAttribute('data-filter');
          applyFilter(f);
          // simple active state
          cats.forEach(b=>b.style.opacity = '0.8'); btn.style.opacity='1';
        });
      });
    }

      // Load the stripe client helper so we can start server-side Checkout sessions
      import('./stripe-client.js').then(mod=>{ window.StripeClient = mod; }).catch(()=>{});

      // Delegate clicks for inner action buttons (Open / Buy / Gratuit / Test QI)
      document.getElementById('gamesGrid').addEventListener('click', (e)=>{
        const openBtn = e.target.closest && e.target.closest('.open-btn');
        if(openBtn){
          e.stopPropagation(); e.preventDefault();
          const id = Number(openBtn.getAttribute('data-open'));
          import('./games/games-index.js').then(mod=>{ mod.default.launch(id); }).catch(()=>{});
          return;
        }

        const buyBtn = e.target.closest && e.target.closest('.buy-btn');
        if(buyBtn){
          e.stopPropagation(); e.preventDefault();
          const gameId = Number(buyBtn.getAttribute('data-game'));
          const price = Number(buyBtn.getAttribute('data-price')) || 499;
          const name = buyBtn.getAttribute('data-name') || `Jeu ${gameId}`;
          // If a bundle payment link exists and the user hasn't purchased
          // the bundle yet, open the bundle link instead of per-game checkout.
          try{
            const bundleOwned = localStorage.getItem('bundlePurchased') === '1';
            const bundleLink = getBundleLink();
            if(bundleLink && !bundleOwned){
              window.open(bundleLink, '_blank', 'noopener');
              return;
            }
          }catch(e){/* continue to per-game flow */}

          // Start a server-side Checkout; StripeClient.startCheckout expects items in cents
          if(window.StripeClient && typeof window.StripeClient.startCheckout === 'function'){
            // include metadata for webhook persistence: game id and user email (if known)
            const userEmail = localStorage.getItem('brainovaUserEmail') || null;
            const metadata = { game_id: String(gameId) };
            if(userEmail) metadata.user_email = userEmail;
            window.StripeClient.startCheckout([{ name, amount: price, quantity: 1 }], metadata);
          }else{
            // Fallback: open hosted link (try bundle then default)
            const fallback = getBundleLink() || './brainova.html?bundle_purchased=1';
            window.open(fallback,'_blank');
          }
          return;
        }

        const freeBtn = e.target.closest && e.target.closest('.free-btn');
        if(freeBtn){
          e.stopPropagation(); e.preventDefault();
          const id = Number(freeBtn.getAttribute('data-open'));
          import('./games/games-index.js').then(mod=>{ mod.default.launch(id); }).catch(()=>{});
          return;
        }

        const testQi = e.target.closest && e.target.closest('.test-qi-btn');
        if(testQi){
          e.stopPropagation(); e.preventDefault();
          const targetId = testQi.getAttribute('data-target') || '0';
          import('./games/games-index.js').then(mod=>{ mod.default.launch(Number(targetId)); }).catch(()=>{});
          return;
        }
      });
  </script>
</body>
</html>