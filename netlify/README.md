Déploiement Netlify / Stripe / Supabase

Fichiers clés:
- netlify/functions/create-checkout-session.js  -> crée une session Stripe Checkout
- netlify/functions/webhook.js                -> reçoit les webhooks Stripe et persiste dans Supabase
- netlify/functions/check-purchase.js        -> endpoint pour vérifier les achats (email/session)

Variables d'environnement à configurer dans Netlify (Site settings -> Build & deploy -> Environment):
- STRIPE_SECRET_KEY = sk_live_xxx (ou sk_test_xxx pour dev)
- STRIPE_WEBHOOK_SECRET = whsec_xxx
- SUPABASE_URL = https://xyz.supabase.co
- SUPABASE_SERVICE_ROLE_KEY = (clé serveur protégée, pour insertion depuis webhook)
- SUPABASE_ANON_KEY = (clé publique pour l'endpoint check-purchase)
- SUCCESS_URL / CANCEL_URL (optionnel)

Guide rapide:
1. Créez une table `purchases` dans Supabase avec au moins les colonnes:
   - session_id (text, unique)
   - customer_email (text)
   - metadata (json)
   - amount_total (integer)
   - payment_status (text)
   - created_at (timestamp)

Example SQL for Supabase (run in SQL editor):

```sql
create table purchases (
   id bigint generated by default as identity primary key,
   session_id text unique,
   customer_email text,
   metadata jsonb,
   amount_total integer,
   payment_status text,
   created_at timestamptz default now()
);
```

2. Déployez sur Netlify (connectez le repo GitHub): Netlify reconnaîtra les fonctions via le dossier `netlify/functions`.

3. Pour tester localement:
   - Installez Netlify CLI: `npm i -g netlify-cli`
   - Lancez: `netlify dev` (les fonctions seront disponibles sous /.netlify/functions/<name>)
   - Utilisez Stripe CLI pour relayer les webhooks: `stripe listen --forward-to http://localhost:8888/.netlify/functions/webhook`

Remarques:
- Ne stockez jamais les clés privées dans le code. Utilisez les variables d'environnement Netlify.
- Le handler webhook attend le body raw exact; Netlify fournit `event.body` comme chaîne, ce qui est compatible ici.

Front: associer un utilisateur aux achats (optionnel)
------------------------------------------------
Pour associer proprement un achat à un utilisateur (afin de déverrouiller les jeux), le front doit fournir un identifiant utilisateur ou un email lors de la création de la session Checkout. Pour tests rapides, vous pouvez définir dans la console navigateur:

```js
localStorage.setItem('brainovaUserEmail', 'me@example.com');
```

Le client inclura cette valeur dans `metadata.user_email` lors du démarrage du Checkout. Le webhook persistera cette donnée en base.

HARDENING: DB migrations & replay
---------------------------------

After deploying, run the DB migrations to ensure idempotency and create a failures table:

1) Run the SQL in `netlify/DB_MIGRATIONS.md` in the Supabase SQL editor to:
   - Add UNIQUE constraint on `purchases.session_id`.
   - Create `webhook_failures` table for failed webhook events.

2) If the webhook upsert fails for any reason, the function will now write the raw event into `webhook_failures`.

3) To replay failures locally, use the helper script (requires SUPABASE env vars):

```powershell
$env:SUPABASE_URL = 'https://<your>.supabase.co'
$env:SUPABASE_SERVICE_ROLE_KEY = '<service-role-key>'
node tools/replay_webhook_failures.js
```

This will call the same processing logic on the stored events and remove entries on success.

Monitoring & next steps
- Add alerts on repeated webhook failures (Netlify logs + Supabase metrics).
- Schedule daily reconciliation job comparing Stripe checkout sessions to `purchases`.

